"use strict";var Env={ok:!0,lang:document.documentElement.getAttribute("lang"),browser:function(){var t=navigator.userAgent;return t.indexOf("Edge")>=0||t.indexOf("MSIE")>=0||t.indexOf("Trident/")>=0}()?"ms":"std",device:void 0!==window.ontouchstart||navigator.maxTouchPoints>0?"touch":"std"},Updater={Topic:function(t){this.name=t,this.upId=-1,this.receivers={handler:[],attr:{},class:[],children:[]}},Record:function(t,e,a){this.topic=t,this.value=e,this.upId=a},topics:{},reportTopic:{name:"_",receivers:[],queue:[],isBusy:!1},startTopics:function(t){for(var e in t)this.startTopic(t[e])},startTopic:function(t){if(!(t in this.topics)){if("_"===t.charAt(0)||t.indexOf("-")>=0)throw"Illegal topic name: starts with '_' or contains '-'";this.topics[t]=new this.Topic(t)}},register:function(t,e,a){a||this.validate(e);var r="function"==typeof t[e+"Handler"];if("_"!==e){var i=this.topics[e].receivers;if(r&&i.handler.push(t),1===t.nodeType&&t.hasAttribute("data-depend-"+e)){var n=t.getAttribute("data-depend-"+e).split(",");for(var s in n){var o=n[s];"children"===o||"class"===o?i[n[s]].push(t):(o in i.attr||(i.attr[o]=[]),i.attr[o].push(t))}}}else r&&this.reportTopic.receivers.push(t)},registerDomReceivers:function(t){this.validate(t);for(var e=getByClass("receiver-"+t),a=0;a<e.length;a++)this.register(e[a],t,!0)},unregister:function(t,e){this.validate(e);var a=[],r=this.topics[e].receivers;if(e+"Handler"in t)a.push(r.handler);else{var i=t.getAttribute("data-depend-"+e).split(",");for(var n in i)a.push(r[i[n]]||r.attr[i[n]]||[])}for(var s in a)a[s].splice(a[s].indexOf(t),1)},push:function(t,e){this.validate(t);var a,r=this.topics[t],i=++r.upId,n=String(e);a=r.receivers.handler.length;for(var s=0;s<a&&i===r.upId;s++)r.receivers.handler[s][t+"Handler"](n);for(var o in r.receivers.attr){a=r.receivers.attr[o].length;for(s=0;s<a&&i===r.upId;s++)this.updateByAttr(r.receivers.attr[o][s],o,r,n)}a=r.receivers.class.length;for(s=0;s<a&&i===r.upId;s++)this.updateByClass(r.receivers.class[s],r,n);a=r.receivers.children.length;for(s=0;s<a&&i===r.upId;s++)this.updateByChildren(r.receivers.children[s],r,n);this.reportTopic.queue.push(new this.Record(r,n,i)),this.processReportQueue()},processReportQueue:function(){var t=Updater.reportTopic;if(!t.isBusy&&0!==t.queue.length){t.isBusy=!0;var e=t.queue.shift();for(var a in t.receivers)t.receivers[a]._Handler(e);t.isBusy=!1,t.queue.length>0&&setTimeout(Updater.processReportQueue,0)}},updateByAttr:function(t,e,a,r){var i="data-"+e+"-"+a.name+"-"+r,n=t.hasAttribute(i)?t.getAttribute(i):"";t.setAttribute(e,n)},updateByClass:function(t,e,a){for(var r=t.attributes,i=[],n=0;n<r.length;n++)if(r[n].name.startsWith("data-class-"+e.name+"-")){var s=r[n].value;r[n].name.endsWith("-"+a)?(t.classList.add(s),i.push(s)):i.indexOf(s)<0&&t.classList.remove(r[n].value)}},updateByChildren:function(t,e,a){for(var r=t.children,i=[],n=0;n<r.length;n++)r[n].hasAttribute("data-"+e.name)&&(r[n].getAttribute("data-"+e.name).split(",").indexOf(a)>=0?i.push(r[n]):(r[n].style.display="none",r[n].classList.remove("active")));for(var s in i)i[s].classList.add("active"),i[s].style.removeProperty("display")},validate:function(t){if(!(t in this.topics)&&t!==this.reportTopic.name)throw"Unstarted topic: "+t}};function newElement(t,e,a,r){var i=document.createElement(t);if(Array.isArray(e))for(var n in e)i.classList.add(e[n]);if(Array.isArray(a))for(var s in a){var o=a[s];i.setAttribute(o[0],o[1])}else if("object"==typeof a)for(var p in a)i.setAttribute(p,a[p]);if(Array.isArray(r))for(var n in r)i.appendChild(r[n]);return i}function newText(t){return document.createTextNode(t)}function removeNode(t){t.parentNode.removeChild(t);var e=t.classList;if(e)for(var a=e.length-1;a>=0;a--){var r=e[a].split("-",2);"receiver"===r[0]&&Updater.unregister(t,r[1])}}function getById(t){return document.getElementById(t)}function getByClass(t){return document.getElementsByClassName(t)}function getOneOf(t){return getByClass(t)[0]}function getByPoint(t){return document.elementFromPoint(t.clientX,t.clientY)}function findActiveChild(t){for(var e=t.children,a=0;a<e.length;a++)if(e[a].classList.contains("active"))return e[a];return null}function setProperties(t,e){for(var a in e)t[a]=e[a]}var App={overrides:{before:{},after:{}}};App.Storage={blackList:["_","view","command","fit"],cache:{},passesTopic:function(t){return this.blackList.indexOf(t)<0},get:function(t){return t in this.cache?this.cache[t]:localStorage.getItem(t)},set:function(t,e){this.cache[t]!==e&&localStorage.setItem(t,e),t.startsWith("_")||(this.cache[t]=e)},clear:function(t){localStorage.removeItem(t),delete this.cache[t]},_Handler:function(t){t.upId===t.topic.upId&&this.passesTopic(t.topic.name)&&this.set(t.topic.name,t.value)}},App.Dev={name:App.Storage.get("device")||Env.device,get std(){return"std"===this.name},get touch(){return!this.std},deviceHandler:function(t){var e=App.Storage,a="_prev_dev_text";if(t===this.name){var r=e.get(a);r&&(App.Writer.textArea.value=r,e.clear(a))}else e.set("device",t),e.set(a,App.Writer.textArea.value),location.reload()}},App.Dev.std&&(App.Literator={alphMaps:[],layoutMaps:[],keyHeadSets:[],alphId:-1,layoutId:-1,alphMap:{},layoutMap:{},keyHeadSet:{},tryTrans:function(t){return this.alphMap[t in this.layoutMap?this.layoutMap[t]:t]||""},alphabetHandler:function(t){this.alphId=t,this.alphMap=this.alphMaps[t],this.setKeyHeadSet()},layoutHandler:function(t){this.layoutId=t,this.layoutMap=this.layoutMaps[t],this.setKeyHeadSet()},setKeyHeadSet:function(){this.keyHeadSet=this.keyHeadSets[this.alphId][this.layoutId]}}),App.Dev.touch&&(App.Literator={allChars:{" ":!0,"\n":!0}}),App.Dev.std&&(App.Writer={textArea:null,buffChar:"",xText:"",init:function(){this.textArea=getById("output-std")},catchKeyDown:function(t){var e=App.Writer,a=t.key;if(!t.ctrlKey&&!t.metaKey&&1===a.length&&" "!==a){var r=!0;if(e.buffChar){var i=e.popBuffChar();e.tryAdd(i+a)?r=!1:e.tryAdd(i)}r&&(App.Literator.keyHeadSet[a]?e.buffChar=a:e.tryAdd(a)),t.preventDefault(),t.stopPropagation()}" "!==t.key&&"Enter"!==t.key||(e.tryAdd(e.popBuffChar()),t.stopPropagation()),e.writeResult()},catchKeyUp:function(t){var e=App.Writer;e.buffChar===t.key&&(e.tryAdd(e.popBuffChar()),e.writeResult())},popBuffChar:function(){var t=this.buffChar;return this.buffChar="",t},tryAdd:function(t){var e=App.Literator.tryTrans(t);return this.xText+=e,e},writeResult:function(){var t=this.xText;t&&(this.write(t),this.xText="",setTimeout(App.DomSignaler.signalByXString,0,t))},write:function(t){this.textArea.setRangeText(t,this.textArea.selectionStart,this.textArea.selectionEnd,"end")}}),App.Dev.touch&&(App.Writer={textArea:{div:null,head:newElement("span",["caret"],null,[newText("")]),tail:newElement("span",null,null,[newText("")]),sStart:0,sEnd:0,get value(){return this.div.innerText},set value(t){this.set(this.tail,""),this.set(this.head,""),this.updateSelection(0),this.insert(t)},insert:function(t){var e=this.sStart,a=this.sEnd;if(e===a)this.add(this.head,t);else{App.Selection.clear();var r=this.value;this.set(this.tail,r.substr(a)),this.set(this.head,r.substr(0,e)+t)}this.updateSelection(e+t.length),this.updateCaret()},add:function(t,e){this.set(t,t.innerText+e)},set:function(t,e){removeNode(t.firstChild),t.appendChild(newText(e))},focus:function(){this.div.focus()},select:function(){App.Selection.make(this.div),this.updateSelection(0,this.value.length),this.updateCaret()},updateSelection:function(t,e){this.sStart=t,this.sEnd=e||t},updateCaret:function(){this.sStart===this.sEnd?this.head.classList.add("caret"):this.head.classList.remove("caret")},catchSelection:function(){if(App.Selection.lock)return!1;var t=App.Writer.textArea,e=App.Selection.get(),a=t.head.innerText,r=a.length;if(e.isCollapsed){var i=t.tail.innerText,n=e.anchorOffset;t.isHead(e.anchorNode)?(t.set(t.head,a.substr(0,n)),t.set(t.tail,a.substr(n)+i),t.updateSelection(n)):(t.set(t.tail,i.substr(n)),t.add(t.head,i.substr(0,n)),t.updateSelection(r+n))}else{var s=e.anchorOffset+(t.isHead(e.anchorNode)?0:r),o=e.focusOffset+(t.isHead(e.focusNode)?0:r);t.updateSelection(Math.min(s,o),Math.max(s,o))}t.updateCaret()},isHead:function(t){return t&&(t===this.head||t.parentNode===this.head)}},init:function(){var t=getById("output-touch"),e=this.textArea;t.appendChild(e.head),t.appendChild(e.tail),e.div=t},write:function(t){switch(t){case"@n":t="\n";break;case"@b":var e=this.textArea,a=e.sStart;if(a===e.sEnd&&a>0){for(var r=e.value,i=1,n=1;n<=4&&a-n>=0;n++)if(r.substring(a-n,a)in App.Literator.allChars){i=n;break}e.sStart-=i}t=""}this.textArea.insert(t)}}),App.Writer.clickWrite=function(t){this.textArea.focus(),this.write(t),setTimeout(App.DomSignaler.signalByXString,0,t)},App.Commands={shiftXChars:function(t){var e=findActiveChild(App.DomMarks.xCharsSelectLi);if(e)for(var a=e.firstElementChild;a=a.nextElementSibling;)for(var r=a.children,i=0;i<r.length;i++)if(r[i].classList.contains("active")){var n=i+parseInt(t);n>=0&&n<r.length&&Updater.push(r[i].getAttribute("data-topic"),n);break}},cycleCaptions:function(t){var e=findActiveChild(App.DomMarks.captionsCycleLi.firstElementChild),a=t<0?e.previousElementSibling||e.parentNode.lastElementChild:e.nextElementSibling||e.parentNode.firstElementChild;Updater.push("captions",a.getAttribute("data-captions"))},changeFontSize:function(t){var e=App.OutFontResizer;t?e.tryChange(+t):e.set(e.styleDefault)},saveText:function(){App.Storage.set("_text",App.Writer.textArea.value),Updater.push("loadable_text",+(App.Writer.textArea.value.length>0)),App.DomSignaler.signalButton(App.DomMarks.saveTextButton)},pasteText:function(){var t=App.Storage.get("_text");t&&(App.Writer.write(t),App.Writer.textArea.focus())},selectAll:function(){App.Writer.textArea.focus(),App.Writer.textArea.select()},eraseSelection:function(){App.Writer.write(""),App.Writer.textArea.focus()},commandHandler:function(t){var e=t.split(":"),a=e[0];"function"==typeof this[a]?this[a](e[1]):console.warn("@command",t,"?")}},App.Dev.std&&(App.Commands.catchKeyDown=function(t){!1!==App.Commands.runMatch(t)&&(t.stopPropagation(),t.preventDefault())},App.Commands.runMatch=function(t){var e=this;switch(t.key){case"Help":return App.SelectsController.clear(),Updater.push("view","info"),!0;case"Escape":return App.SelectsController.clear(),Updater.push("view","workspace"),!0;case"ArrowLeft":return t.ctrlKey&&e.shiftXChars(-1);case"ArrowRight":return t.ctrlKey&&e.shiftXChars(1);case"PageUp":return"workspace"===App.ViewController.current&&e.cycleCaptions(-1);case"PageDown":return"workspace"===App.ViewController.current&&e.cycleCaptions(1);case"s":return t.ctrlKey&&e.saveText();case"-":case"_":return t.ctrlKey&&t.shiftKey&&e.changeFontSize(-1);case"+":case"=":return t.ctrlKey&&t.shiftKey&&e.changeFontSize(1);case"0":case")":return t.ctrlKey&&t.shiftKey&&e.changeFontSize(0)}return!1}),App.DomMarks={kBoards:[],get activeKBoard(){return this.kBoards[App.Storage.get("alphabet")]},get textArea(){return App.Writer.textArea.div||App.Writer.textArea},workspace:null,kBoardSpace:null,editorSpace:null,xCharsSelectLi:null,captionsCycleLi:null,saveTextButton:null,goTopButton:null,init:function(){setProperties(this,{workspace:getById("workspace"),kBoardSpace:getById("kboard-space"),editorSpace:getById("editor-space"),xCharsSelectLi:getById("selector-xchars"),captionsCycleLi:getById("cycle-captions"),saveTextButton:getById("save-text-button"),goTopButton:getById("go-top")})}},App.DomSignaler={init:function(){this.signalByXString=function(t){for(var e=App.DomMarks.activeKBoard.backMap,a="",r=null,i=t.length-1;i>=0;i--)(r=e[a=t.charAt(i)+a])&&(App.DomSignaler.signalButton(r,20*i),a="")}},signalByXString:function(){},signalButton:function(t,e){var a=e||0;setTimeout((function(){t.classList.add("signal")}),a),setTimeout((function(){t.classList.remove("signal")}),250+a)}},App.ViewController={scrollChecking:!1,current:null,get requestedView(){return this.isInfoSectionHash(window.location.hash)?"info":"workspace"},viewHandler:function(t){this.current=t,this.clearScrollCheck();var e=window.location.hash;switch(t){case"info":this.isInfoSectionHash(e)||(window.location.hash="info"),this.scrollChecking=setInterval(this.scrollHandler,250);break;case"workspace":e.length>0&&(window.location.hash=""),App.DomMarks.goTopButton.classList.remove("active")}},isInfoSectionHash:function(t,e){return"#info"===t||"i"===t.charAt(1)&&(e||getById(t.substr(1)))},scrollHandler:function(){var t=App.DomMarks.goTopButton.classList;document.scrollingElement.scrollTop>window.innerHeight?t.add("active"):t.remove("active")},clearScrollCheck:function(){!1!==this.scrollChecking&&(clearInterval(this.scrollChecking),this.scrollChecking=!1)}},App.Fitter={setting:null,lock:!1,repeat:!1,compact:!1,compactRet:!1,allFitClasses:["fit-w","fit-h","fit-max","compact"],fitClass:null,boxMaxSize:0,boxMinSize:0,fit:function(){var t=App.Fitter;if(!t.lock||t.compactRet){t.lock=!0,document.body.style.height=window.innerHeight+"px";var e,a,r,i,n=App.DomMarks.kBoardSpace,s=Math.abs(window.innerWidth-n.offsetWidth)<100;n.classList.add("resizing"),t.compactRet||"compact"===t.setting?(t.compact=!0,t.compactRet=!1,e=t.fitCompact,a=App.DomMarks.activeKBoard,r=s,i="compact"):(t.compact=!1,s?(e=t.fitStdNarrowScr,a=getOneOf("tall"),i="fit-w"):(e=t.fitStdWideScr,a=getOneOf("wide"),i="fit-h"),r=a.firstElementChild.firstElementChild.firstElementChild),t.preset(a,i),setTimeout(e,0,t,n,a,r)}else t.repeat=!0},fitCompact:function(t,e,a,r){for(var i=getComputedStyle(a),n=parseInt(i.getPropertyValue("padding-top"))+parseInt(i.getPropertyValue("padding-bottom")),s=a.children,o=0;o<s.length;o++)for(var p=s[o].children,l=0;l<p.length;l++)n+=p[l].offsetHeight;var c=e.offsetHeight-n;if(r){var h=App.DomMarks.editorSpace;h.style.height=h.offsetHeight+c+"px"}else a.style.top=c/2+"px";t.release(e,a)},fitStdNarrowScr:function(t,e,a,r){a.offsetHeight>=e.offsetHeight&&(e.classList.remove("fit-w"),e.classList.add("fit-h")),setTimeout(t.finalizeStd,0,t,e,a,r)},fitStdWideScr:function(t,e,a,r){for(var i=r.offsetHeight,n=!0,s=a.children,o=0;n&&o<s.length;o++)for(var p=s[o].children,l=0;n&&l<p.length;l++){var c=p[l];(c.offsetHeight>=2*i||c.offsetWidth>=e.offsetWidth)&&(e.classList.remove("fit-h"),e.classList.add("fit-w"),n=!1)}setTimeout(t.finalizeStd,0,t,e,a,r)},finalizeStd:function(t,e,a,r){var i=r.offsetWidth;if("auto"===t.setting&&i<t.boxMinSize)return t.compactRet=!0,void t.fit();i>=t.boxMaxSize&&(e.classList.remove("fit-w","fit-h"),e.classList.add("fit-max")),t.release(e,a)},release:function(t,e){var a=App.DomMarks.activeKBoard;e!==a&&(e.style.display="none",a.style.removeProperty("display")),this.lock=!1,this.repeat?(this.repeat=!1,this.fit()):(t.classList.remove("resizing"),Updater.push("fit",this.fitClass))},preset:function(t,e){this.fitClass=e;var a=App.DomMarks;a.editorSpace.style.removeProperty("height");var r=a.kBoardSpace.classList,i=this.allFitClasses;for(var n in i)i[n]!==e&&r.remove(i[n]);r.add(e);var s=a.kBoards;for(var n in s)s[n]!==t&&(s[n].style.display="none"),s[n].style.removeProperty("top");t.style.removeProperty("display")},viewHandler:function(t){"workspace"===t&&this.fit()},alphabetHandler:function(){this.alphabetHandler=function(){this.compact&&setTimeout(this.fit,0)}},kbmodeHandler:function(t){this.setting=t,this.kbmodeHandler=function(t){this.setting=t,this.fit()}},init:function(){var t=newElement("div",["extremes-probe","tmp"]);document.body.appendChild(t);var e=getComputedStyle(t);this.boxMaxSize=parseInt(e.getPropertyValue("max-width")),this.boxMinSize=parseInt(e.getPropertyValue("min-width"))}},App.Messages={topics:{touch:{show:!1,p:null,get on(){return App.Dev.touch}},compact:{show:!1,p:null,on:!1,rec:{start:function(t){Updater.register(t,"fit")},stop:function(t){Updater.unregister(t,"fit")}},fitHandler:function(t){this.on="compact"===t,App.Messages.update(this),App.Messages.superUpdate()}}},container:null,n:2,showN:0,supShow:!1,init:function(){this.container=getById("messages");var t=[],e=[];for(var a in this.topics){var r=this.topics[a];r.p=getById("msg-"+a),App.Storage.get("_msg_"+a)?t.push(a):(r.rec&&r.rec.start(r),this.update(r),e.push(r))}for(var i in t)this.remove(t[i]);if(e.length>0){var n=function(t){for(var e=t.target;!e.id;)e=e.parentNode;App.Messages.dismiss(e.id.split("-")[1])};for(var s in e)e[s].p.addEventListener("click",n)}this.superUpdate()},superUpdate:function(){var t=this.container;this.n<=0?(setTimeout(removeNode,250,t),delete App.Messages):this.showN>0&&!this.supShow?(t.classList.remove("hidden"),this.supShow=!0):this.showN<=0&&this.supShow&&(setTimeout((function(t){t.classList.add("hidden")}),250,t),this.supShow=!1)},update:function(t){var e=t.p.classList;t.on?(e.remove("hidden"),t.show||(this.showN++,t.show=!0)):(e.add("hidden"),t.show&&(this.showN--,t.show=!1))},dismiss:function(t){var e=this.topics[t];e.rec&&e.rec.stop(e),App.Storage.set("_msg_"+t,1),this.remove(t),this.superUpdate()},remove:function(t){var e=this.topics[t];e.show&&this.showN--,this.n--,e.p.classList.add("fading"),setTimeout(removeNode,250,e.p),delete this.topics[t]}},App.OutFontResizer={styleDefault:0,current:0,max:0,min:0,step:0,lineRatio:0,tryChange:function(t){var e=this.current+t*this.step;this.validate(e)&&this.set(e)},validate:function(t){return t>=this.min&&t<=this.max},set:function(t){var e=App.DomMarks.textArea;e.style.fontSize=t+"px",e.style.lineHeight=this.lineRatio*t+"px",this.current=t,App.Storage.set("_fontsize",t)},init:function(){var t=App.DomMarks.textArea,e=getComputedStyle(t),a=parseInt(e.getPropertyValue("font-size"));setProperties(this,{styleDefault:a,min:parseInt(t.getAttribute("data-min-font-size")),max:parseInt(t.getAttribute("data-max-font-size")),step:parseInt(t.getAttribute("data-step-font-size")),lineRatio:parseFloat(e.getPropertyValue("line-height"))/a});var r=parseInt(App.Storage.get("_fontsize"));this.set(this.validate(r)?r:a)}},App.SelectsController={active:{top:null,sub:null},subActivation:!1,handle:function(t){t.classList.contains("sub-select")?this.handleSub(t):this.handleTop(t)},handleTop:function(t){this.clearSub(),this.subActivation=!1,t===this.active.top?this.clearTop():this.setActive(t,"top")},handleSub:function(t){if(t===this.active.sub)return this.clearSub(),void(this.subActivation&&this.clearTop());this.active.top||(this.setActive(this.findContainingSelect(t.parentNode,!1),"top"),this.subActivation=!0),this.setActive(t,"sub")},setActive:function(t,e){var a=!0;this.active[e]&&(this.deactivate(this.active[e],!1),this.active[e].classList.add("lock"),a=!1),this.activate(t,a),this.active[e]=t},clear:function(){this.clearSub(),this.clearTop(),this.subActivation=!1},clearTop:function(){this.active.top&&(this.deactivate(this.active.top,!0),this.active.top=null,this.subActivation=!1)},clearSub:function(){this.active.sub&&(this.deactivate(this.active.sub,!0),this.active.sub=null)},activate:function(t,e){e&&this.setSiblingsLock(t,"add"),t.classList.remove("lock"),t.classList.add("active")},deactivate:function(t,e){e&&this.setSiblingsLock(t,"remove"),t.classList.remove("active")},setSiblingsLock:function(t,e){for(var a=t;(a=a.nextElementSibling||a.parentNode.firstElementChild)!==t;)a.classList.contains("select")&&a.classList[e]("lock")},findContainingSelect:function(t,e){for(var a=0,r=t,i=null;a<5&&!i&&r&&r.classList;a++,r=r.parentNode)if(r.classList.contains("select")&&!r.classList.contains("disabled"))i=r;else if(e&&r.hasAttribute("data-topic"))break;return i}},App.ClickEvents={start:"",end:"",single:"",move:"",init:function(){var t={start:["touchstart","mousedown"],end:["touchend","mouseup"],single:["touch","tap","click","touchend","mouseup"],move:["touchmove","mousemove"]};for(var e in t)for(var a in t[e])if("on"+t[e][a]in document.body){this[e]=t[e][a];break}}},App.ClickRepeater={target:null,repeating:!1,tryId:-1,init:function(){App.ClickEvents.move.startsWith("touch")&&(this.isOut=this.isOutTouch),delete this.isOutTouch},catchStart:function(t){var e=App.ClickRepeater;e.clear();var a=t.target;(a.hasAttribute("data-xchar")||a.classList.contains("repeatable"))&&(e.onMove("add"),e.target=a,setTimeout(e.tryStart,275,++e.tryId))},catchMove:function(t){var e=App.ClickRepeater;e.target&&e.isOut(t)&&e.clear()},tryStart:function(t){var e=App.ClickRepeater;t===e.tryId&&e.target&&!e.repeating&&(e.repeating=setInterval(e.repeat,125))},repeat:function(){var t=App.ClickRepeater;t.target?t.target[App.ClickEvents.single]():t.repeating&&(clearInterval(t.repeating),t.repeating=!1)},clear:function(){var t=App.ClickRepeater;t.target&&(t.onMove("remove"),t.target=null)},onMove:function(t){App.DomMarks.workspace[t+"EventListener"](App.ClickEvents.move,App.ClickRepeater.catchMove)},isOut:function(t){return getByPoint(t)!==this.target},isOutTouch:function(t){var e=t.targetTouches;return 1!==e.length||getByPoint(e[0])!==this.target}},App.Dev.touch&&(App.Selection={root:document.getSelection?document:window,eName:"selectionchange",eElement:null,lock:!1,init:function(){"on"+this.eName in this.root?this.eElement=this.root:(this.eName=App.ClickEvents.end,this.eElement=App.DomMarks.textArea)},get:function(){return this.root.getSelection()},clear:function(t){return(t||this.get()).removeAllRanges()},make:function(t){this.lock=!0;var e=t||App.DomMarks.textArea,a=this.get(),r=document.createRange();r.selectNodeContents(e),this.clear(a),a.addRange(r),setTimeout((function(){App.Selection.lock=!1}),0)}}),App.Constructor={AlphMap:function(t){for(var e in t.entities){var a=t.entities[e];for(var r in a.keys)this[a.keys[r]]=a.chars[0]}},alphabetsData:[],alphId:-1,layoutsData:[],layId:-1,run:function(){App.MenuBuilder.alphSelectLi=getById("selector-alphabet"),App.Dev.std?(App.MenuBuilder.layoutSelectLi=getById("selector-layout"),this.buildLayouts(),this.buildAlphabets(),this.buildKeyHeadSets()):(App.KBoardBuilder.controlsProtos=getById("touch-controls").children,this.buildAlphabets())},buildAlphabets:function(){for(var t;t=this.alphabetsData.shift();)this.buildAlphabet(t);var e=App.KBoardBuilder.wideKBoards;for(var a in e)e[a].classList.add("wide");var r=App.KBoardBuilder.tallKBoards;for(var a in r)r[a].classList.add("tall")},buildAlphabet:function(t){var e,a=++this.alphId,r=null;App.Dev.std?(r=new this.AlphMap(t),App.Literator.alphMaps.push(r),e=function(t){for(var e in this.keys)this.map[this.keys[e]]=this.chars[t];App.DomSignaler.signalByXString(this.chars[t])}):e=function(t){App.DomSignaler.signalByXString(this.chars[t])};var i=[];for(var n in t.entities){var s=t.entities[n];if(App.Dev.touch)for(var o in s.chars)App.Literator.allChars[s.chars[o]]=!0;if(s.chars.length>1){var p="xchar"+a+"_"+n;s.topicName=p,s.map=r,s[p+"Handler"]=e,Updater.startTopic(p),Updater.register(s,p),i.push(s)}}App.MenuBuilder.addAlphabetEntry(t.meta,a),App.MenuBuilder.addXCharsEntry(i,a),App.KBoardBuilder.buildAndAddKboard(t,a)},buildLayouts:function(){for(var t;t=this.layoutsData.shift();)this.buildLayout(t)},buildLayout:function(t){var e=++this.layId;App.Literator.layoutMaps.push(t.map),App.MenuBuilder.addLayoutEntry(t.meta,e)},buildKeyHeadSets:function(){for(var t=0;t<App.Literator.alphMaps.length;t++){var e=App.Literator.alphMaps[t];App.Literator.keyHeadSets[t]=[];for(var a=0;a<App.Literator.layoutMaps.length;a++){var r=App.Literator.layoutMaps[a],i={};for(var n in e)n.length>1&&null!==r[n]&&(i[n.charAt(0)]=!0);App.Literator.keyHeadSets[t][a]=i}}},enterAlphabets:function(){for(var t=0;t<arguments.length;t++)this.alphabetsData.push(arguments[t])},enterLayouts:function(){for(var t=0;t<arguments.length;t++)this.layoutsData.push(arguments[t])}},App.MenuBuilder={alphSelectLi:null,layoutSelectLi:null,addAlphabetEntry:function(t,e){var a=this.alphSelectLi.children[0].children[1],r=this.alphSelectLi.children[1],i=t.name[Env.lang];a.appendChild(newElement("span",null,{"data-alphabet":e},[newText(i)])),r.appendChild(newElement("li",null,null,[newElement("button",["receiver-alphabet"],[["data-topic","alphabet"],["data-alphabet",e],["data-depend-alphabet","class"],["data-class-alphabet-"+e,"active"]],[newElement("span",null,null,[newText(i)]),newText(" "),newElement("span",["xtext"],null,[newText(t.sample)])])]))},addXCharsEntry:function(t,e){var a=App.DomMarks.xCharsSelectLi;if(a.children[0].children[1].appendChild(newElement("span",null,{"data-alphabet":e},[newText(t.length)])),0!==t.length){var r=newElement("ul",["selector-xchar"],{"data-alphabet":e}),i=a.children[1].children[0];for(var n in r.appendChild(i.cloneNode(!0)),t){var s=t[n],o=s.topicName,p=newElement("li");for(var l in s.chars)p.appendChild(newElement("button",["xtext","receiver-"+o].concat(0==l?["active"]:[]),[["data-topic",o],["data-"+o,l],["data-depend-"+o,"class"],["data-class-"+o+"-"+l,"active"]],[newText(s.chars[l])]));r.appendChild(p)}a.appendChild(r)}else a.setAttribute("data-class-alphabet-"+e,"disabled")},addLayoutEntry:function(t,e){this.layoutSelectLi.children[1].appendChild(newElement("li",null,null,[newElement("button",["receiver-layout"],[["data-topic","layout"],["data-layout",e],["data-depend-layout","class"],["data-class-layout-"+e,"active"]],[newText(t.name)])]))}},App.KBoardBuilder={xCharToButton:{},keyToEntity:{},wideKBoards:[],maxColsN:0,tallKBoards:[],maxRowsN:0,subMaxSectionsN:0,controlsProtos:null,buildAndAddKboard:function(t,e){this.xCharToButton={},this.keyToEntity={};var a=newElement("div",["kboard"],{"data-alphabet":e});for(var r in t.entities){var i=t.entities[r];for(var n in this.buildXCharButtons(i),i.keys)this.keyToEntity[i.keys[n]]=i}var s=0,o=0;for(var p in t.order){o++;var l=newElement("section"),c=t.order[p];for(var h in c){s++;var d=newElement("section",["row"]),u=c[h],f=u.length;this.checkForWide(a,f);for(n=0;n<f;n++)d.appendChild(this.buildXLetterBox(u[n]));l.appendChild(d)}a.appendChild(l)}App.Dev.touch&&this.addControlButtons(d),this.checkForTall(a,s,o),a.backMap=this.xCharToButton,App.DomMarks.kBoards.push(a),App.DomMarks.kBoardSpace.appendChild(a)},buildXCharButtons:function(t){for(var e=t.chars.length,a=0;a<e;a++){var r=t.chars[a];this.xCharToButton[r]=newElement("button",["xtext"],[["data-xchar",r]].concat(e>1?[["data-"+t.topicName,a]]:[]).concat(a>0?[["style","display: none;"]]:[]),[newText(r)])}},buildXLetterBox:function(t){for(var e=this.keyToEntity[t],a=e.chars.length,r=newElement("div",["xletter-box"].concat(a>1?["receiver-"+e.topicName]:[]),a>1?[["data-depend-"+e.topicName,"children"]]:null),i=0;i<a;i++)r.appendChild(this.xCharToButton[e.chars[i]]);var n=e.roman.split(" ");return r.appendChild(newElement("p",["roman"],null,[newElement("i",null,null,[newElement("span",null,null,[newText(n[0])])].concat(n.length>1?[newText(" "+n.slice(1).join(" "))]:[]))])),App.Dev.std&&r.appendChild(this.buildKeysP(e)),r},checkForWide:function(t,e){e>this.maxColsN?(this.maxColsN=e,this.wideKBoards=[t]):e===this.maxColsN&&this.wideKBoards.indexOf(t)<0&&this.wideKBoards.push(t)},checkForTall:function(t,e,a){e>this.maxRowsN||e===this.maxRowsN&&a>this.subMaxSectionsN?(this.maxRowsN=e,this.subMaxSectionsN=a,this.tallKBoards=[t]):e===this.maxRowsN&&a===this.subMaxSectionsN&&this.tallKBoards.indexOf(t)<0&&this.tallKBoards.push(t)},buildKeysP:function(t){var e={},a=0;for(var r in App.Literator.layoutMaps){e[s=this.resolveKeys(App.Literator.layoutMaps[r],t.keys)]?e[s]+=","+r:(e[s]=r,a++)}var i=a>1,n=[];for(var s in e){var o=s.split(" ");n.push(newElement("span",null,i?{"data-layout":e[s]}:null,[newElement("span",null,null,[newText(o[0])])].concat(o.length>1?[newText(" "+o.slice(1).join(" "))]:[])))}return newElement("p",["keys","typetext"].concat(i?["receiver-layout"]:[]),[["data-captions","keys"]].concat(i?[["data-depend-layout","children"]]:[]),n)},resolveKeys:function(t,e){var a=[],r=[];for(var i in e){var n=e[i],s=!0;for(var o in t){var p=t[o];null===p&&o===n?s=!1:p===n&&r.push(o)}s&&a.push(n)}return a.concat(r).join(" ")},addControlButtons:function(t){for(var e=0;e<this.controlsProtos.length;e++){var a=this.controlsProtos[e].cloneNode(!0),r=a.firstElementChild;t.appendChild(a),this.xCharToButton[r.getAttribute("data-xchar")]=r}}},App.EventAssigner={run:function(){var t=this.assignments;for(var e in t)t[e]&&t[e]()},assignments:{keyboardWriting:App.Dev.std&&function(){var t=App.Writer.textArea;t.addEventListener("keydown",App.Writer.catchKeyDown),t.addEventListener("keyup",App.Writer.catchKeyUp)},commandKeys:App.Dev.std&&function(){document.addEventListener("keydown",App.Commands.catchKeyDown)},touchSelection:App.Dev.touch&&function(){App.Selection.eElement.addEventListener(App.Selection.eName,App.Writer.textArea.catchSelection)},clickWriting:function(){App.DomMarks.kBoardSpace.addEventListener(App.ClickEvents.single,(function(t){t.target.hasAttribute("data-xchar")&&App.Writer.clickWrite(t.target.getAttribute("data-xchar"))}))},menuClicks:function(){for(var t=function(t){for(var e=null,a=0,r=t.target;a<3&&r&&!e;a++)(e=r.getAttribute("data-topic"))||(r=r.parentNode);e&&Updater.push(e,r.getAttribute("data-"+e))},e=getByClass("menu"),a=e.length-1;a>=0;a--)e[a].addEventListener(App.ClickEvents.single,t);getById("main-menu").addEventListener(App.ClickEvents.single,(function(t){var e=App.SelectsController.findContainingSelect(t.target,!0);e&&(t.stopPropagation(),App.SelectsController.handle(e))}));App.DomMarks.workspace.addEventListener(App.ClickEvents.single,(function(t){App.SelectsController.findContainingSelect(t.target,!1)||App.SelectsController.clear()}))},clickRepeats:function(){for(var t=App.ClickRepeater,e=[App.DomMarks.kBoardSpace,getById("toolbar")],a=e.length-1;a>=0;a--)e[a].addEventListener(App.ClickEvents.start,t.catchStart),e[a].addEventListener(App.ClickEvents.end,t.clear)},resizeHandling:function(){window.addEventListener("resize",App.Fitter.fit)},contextMenuBlocking:App.Dev.touch&&function(){App.DomMarks.workspace.addEventListener("contextmenu",(function(t){for(var e=t.target,a=0;a<2&&e;a++,e=e.parentNode)if(e===App.Writer.textArea.div)return;t.stopPropagation(),t.preventDefault()}))}}},App.buildOutline=function(t){for(var e=function(t,a){if(!(a>0&&"SECTION"===t.tagName&&t.id&&App.ViewController.isInfoSectionHash("#"+t.id,!0)))return null;var r=t.children,i=r[0];if(2!==i.tagName.length||"H"!==i.tagName.charAt(0))return null;for(var n=newElement("li",null,null,[newElement("a",null,{href:"#"+t.id},[newText(i.textContent)])]),s=[],o=1,p=null;o<r.length;o++)(p=e(r[o],a-1))&&s.push(p);return s.length>0&&n.appendChild(newElement("ul",null,null,s)),n},a=getById("outline").children[1],r=getById("info-content").children,i=0,n=null;i<r.length;i++)(n=e(r[i],t))&&a.appendChild(n)},App.removeLoader=function(){setTimeout((function(){getById("loader").classList.add("fading"),setTimeout((function(){removeNode(getById("loader")),document.body.classList.remove("sup-loader")}),500)}),Math.max(0,500-(timestamps.run1-timestamps.head)))},App.overrides.before.NoGoOnCssFlexLack={test:function(){return!("flex-flow"in document.body.style)},run:function(){Env.ok=!1,console.error("Deficient browser (indicated by no flex support).")}},App.overrides.before.JsStringMethodsLack={test:function(){return this.hasSw="".startsWith,this.hasEw="".endsWith,!(this.hasSw&&this.hasEw)},run:function(){this.hasSw||(String.prototype.startsWith=function(t){return this.substr(0,t.length)===t}),this.hasEw||(String.prototype.endsWith=function(t){return this.substr(this.length-t.length)===t})}},App.overrides.after.JsSetRangeTextLack={test:function(){return App.Dev.std&&!App.Writer.textArea.setRangeText},run:function(){App.Writer.textArea.setRangeText=function(t){var e=this.value,a=this.selectionStart;this.value=e.substr(0,a)+t+e.substr(this.selectionEnd),this.selectionStart=this.selectionEnd=a+t.length}}},App.overrides.before.JsScrollingElementLack={test:function(){return!document.scrollingElement},run:function(){document.scrollingElement=document.documentElement}},App.overrides.after.MsKeyboardEvents={test:function(){return App.Dev.std&&"ms"===Env.browser},run:function(){App.MsKAdapter=this.MsKAdapter,App.Writer.textArea.removeEventListener("keydown",App.Writer.catchKeyDown),App.Writer.textArea.addEventListener("keypress",(function(t){App.Writer.catchKeyDown(App.MsKAdapter.normalize(t))})),document.removeEventListener("keydown",App.Commands.catchKeyDown),window.addEventListener("keydown",(function(t){App.Commands.catchKeyDown(App.MsKAdapter.normalize(t))}))},MsKAdapter:{map:{Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",get Unidentified(){switch(event.keyCode){case 187:return"=";case 189:return"-";default:return String.fromCharCode(event.keyCode)}}},normalize:function(t){return{key:this.map[t.key]||t.key,ctrlKey:t.ctrlKey&&!t.altKey,shiftKey:t.shiftKey,preventDefault:this.preventDefault,stopPropagation:this.stopPropagation}},preventDefault:function(){event.preventDefault()},stopPropagation:function(){event.stopPropagation()}}},App.overrides.after.TouchDevCaptions={test:function(){return App.Dev.touch&&"keys"===App.Storage.get("captions")},run:function(){Updater.push("captions","off")}},App.run=function(){for(var t in timestamps.run0=Date.now(),App.overrides.before){(i=App.overrides.before[t]).test()&&(console.log("@"+t),i.run())}for(var e in App.Writer.init(),App.DomMarks.init(),App.ClickEvents.init(),App.ClickRepeater.init(),App.Fitter.init(),App.Dev.touch&&App.Selection.init(),App.Constructor.run(),App.EventAssigner.run(),Updater.startTopics(["device","alphabet","layout","command","view","kbmode","captions","xfont","theme","toolbar","loadable_text","fit"]),Updater.register(App.Storage,"_"),Updater.register(App.Dev,"device"),App.Dev.std&&(Updater.register(App.Literator,"alphabet"),Updater.register(App.Literator,"layout")),Updater.register(App.Commands,"command"),Updater.register(App.ViewController,"view"),Updater.register(App.Fitter,"view"),Updater.register(App.Fitter,"alphabet"),Updater.register(App.Fitter,"kbmode"),Updater.topics)Updater.registerDomReceivers(Updater.topics[e].name);var a={device:App.Dev.name,alphabet:0,layout:0,xfont:"noto",kbmode:"auto",toolbar:App.Dev.std?"on":"off",captions:App.Dev.std?"roman":"off",theme:App.Dev.std?"bright":"dark"};for(var r in a)Updater.push(r,App.Storage.get(r)||a[r]);for(var e in Updater.topics){r=Updater.topics[e].name;App.Storage.passesTopic(r)&&!(r in a)&&Updater.push(r,App.Storage.get(r)||0)}for(var t in Updater.push("view",App.ViewController.requestedView),App.DomSignaler.init(),App.Messages.init(),App.OutFontResizer.init(),App.buildOutline(2),App.overrides.after){var i;(i=App.overrides.after[t]).test()&&(console.log("@"+t),i.run())}timestamps.run1=Date.now(),Env.ok&&App.removeLoader(),App.cleanUp()},App.cleanUp=function(){for(var t in timestamps.clean0=Date.now(),window.removeEventListener("load",App.run),delete App.overrides,delete App.Constructor,delete App.MenuBuilder,delete App.KBoardBuilder,delete App.EventAssigner,delete App.buildOutline,delete App.removeLoader,delete App.run,delete App.cleanUp,App)delete App[t].init;setProperties(Updater.topics.device.receivers,{attr:{},class:[],children:[]});for(var e=getByClass("tmp");e.length>0;)removeNode(e[0]);timestamps.clean1=Date.now(),console.log("@ready",timestamps.clean1-timestamps.head+"ms")},App.Constructor.enterAlphabets({meta:{name:{en:"Elder Futhark",pl:"Futhark starszy"},sample:"ᚠᚢᚦᚨᚱᚲ"},entities:[{chars:["ᚠ"],roman:"f",keys:["f"]},{chars:["ᚢ"],roman:"u",keys:["u"]},{chars:["ᚦ"],roman:"þ",keys:["th"]},{chars:["ᚨ"],roman:"a",keys:["a"]},{chars:["ᚱ"],roman:"r",keys:["r"]},{chars:["ᚲ"],roman:"k",keys:["k"]},{chars:["ᚷ"],roman:"g",keys:["g"]},{chars:["ᚹ"],roman:"w",keys:["w"]},{chars:["ᚺ","ᚻ"],roman:"h",keys:["h"]},{chars:["ᚾ"],roman:"n",keys:["n"]},{chars:["ᛁ"],roman:"i",keys:["i"]},{chars:["ᛃ"],roman:"j",keys:["j"]},{chars:["ᛇ"],roman:"ï æ",keys:["I","E","ae"]},{chars:["ᛈ"],roman:"p",keys:["p"]},{chars:["ᛉ"],roman:"z ʀ",keys:["z","R"]},{chars:["ᛊ","ᛋ"],roman:"s",keys:["s"]},{chars:["ᛏ"],roman:"t",keys:["t"]},{chars:["ᛒ"],roman:"b",keys:["b"]},{chars:["ᛖ"],roman:"e",keys:["e"]},{chars:["ᛗ"],roman:"m",keys:["m"]},{chars:["ᛚ"],roman:"l",keys:["l"]},{chars:["ᛜ"],roman:"ŋ ng",keys:["ng"]},{chars:["ᛟ"],roman:"o",keys:["o"]},{chars:["ᛞ"],roman:"d",keys:["d"]},{chars:["᛫"],roman:"•",keys:[".",","]},{chars:["᛬"],roman:":",keys:[":",";"]}],order:[[["f","u","th","a","r","k","g","w"],["h","n","i","j","I","p","z","s"],["t","b","e","m","l","ng","o","d"]],[[".",":"]]]},{meta:{name:{en:"American Futharch",pl:"American Futharch"},sample:"ᚠᚢᚦᚩᚱᚳ"},entities:[{chars:["ᚠ"],roman:"f",keys:["f"]},{chars:["ᚢ"],roman:"u",keys:["u"]},{chars:["ᚦ"],roman:"þ",keys:["th"]},{chars:["ᚩ"],roman:"o",keys:["o"]},{chars:["ᚱ"],roman:"r",keys:["r"]},{chars:["ᚳ"],roman:"ch",keys:["ch"]},{chars:["ᚷ"],roman:"g",keys:["g"]},{chars:["ᚹ"],roman:"w",keys:["w"]},{chars:["ᚻ"],roman:"h",keys:["h"]},{chars:["ᚾ"],roman:"n",keys:["n"]},{chars:["ᛁ"],roman:"i",keys:["i"]},{chars:["ᛄ"],roman:"y",keys:["y"]},{chars:["ᛇ"],roman:"ï ʒ ɨ",keys:["I"]},{chars:["ᛈ"],roman:"p",keys:["p"]},{chars:["ᛉ"],roman:"z",keys:["z"]},{chars:["ᛋ"],roman:"s",keys:["s"]},{chars:["ᛏ"],roman:"t",keys:["t"]},{chars:["ᛒ"],roman:"b",keys:["b"]},{chars:["ᛖ"],roman:"e",keys:["e"]},{chars:["ᛗ"],roman:"m",keys:["m"]},{chars:["ᛚ"],roman:"l",keys:["l"]},{chars:["ᛝ"],roman:"ŋ ng",keys:["ng"]},{chars:["ᛟ"],roman:"œ",keys:["oe"]},{chars:["ᛞ"],roman:"d",keys:["d"]},{chars:["ᚣ"],roman:"ull",keys:["U"]},{chars:["ᛡ"],roman:"v",keys:["v"]},{chars:["ᛊ"],roman:"ship",keys:["sh"]},{chars:["ᛠ"],roman:"ea",keys:["ea"]},{chars:["ᛯ"],roman:"genre",keys:["J"]},{chars:["ᛨ"],roman:"ð",keys:["dh"]},{chars:["ᚴ"],roman:"k",keys:["k"]},{chars:["ᛥ"],roman:"j",keys:["j"]},{chars:["ᚫ"],roman:"æ",keys:["ae"]},{chars:["᛫"],roman:"•",keys:[".",","]},{chars:["᛬"],roman:":",keys:[":",";"]},{chars:["⋮"],roman:"q",keys:["q"]},{chars:["᛭"],roman:"+",keys:["+","="]}],order:[[["f","u","th","o","r","ch","g","w"],["h","n","i","y","I","p","z","s"],["t","b","e","m","l","ng","oe","d"],["U","v","sh","ea","J","dh","k","j"],["ae"]],[[".",":","q","+"]]]}),App.Dev.std&&App.Constructor.enterLayouts({meta:{name:"UNI"},map:{}},{meta:{name:"DA/NO"},map:{"æ":"ae",ae:null,"ø":"oe",oe:null,"å":"A",A:null,O:null,"Æ":"ea"}},{meta:{name:"DE"},map:{"ä":"ae",ae:null,"ö":"oe",oe:null,"Ä":"ea"}},{meta:{name:"FO"},map:{"ð":"dh",dh:null,"æ":"ae",ae:null,"ø":"oe",oe:null,"á":"A","í":"I","ó":"O",O:null,"Æ":"ea"}},{meta:{name:"IS"},map:{"þ":"th",th:null,"ð":"dh",dh:null,"æ":"ae",ae:null,"ö":"oe",oe:null,"á":"A","í":"I","ó":"O",O:null,"Æ":"ea"}},{meta:{name:"SV"},map:{"å":"A",A:null,O:null,"ä":"ae",ae:null,"ö":"oe",oe:null,"Ä":"ea"}}),window.addEventListener("load",App.run);