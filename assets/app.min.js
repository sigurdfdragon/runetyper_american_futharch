"use strict";var Env={ok:!0,lang:document.documentElement.getAttribute("lang"),browser:function(){var e=navigator.userAgent;return e.indexOf("Edge")>=0||e.indexOf("MSIE")>=0||e.indexOf("Trident/")>=0}()?"ms":"std",device:void 0!==window.ontouchstart||navigator.maxTouchPoints>0?"touch":"std"},Updater={Topic:function(e){this.name=e,this.upId=-1,this.receivers={handler:[],attr:{},class:[],children:[]}},Record:function(e,t,a){this.topic=e,this.value=t,this.upId=a},topics:{},reportTopic:{name:"_",receivers:[],queue:[],isBusy:!1},startTopics:function(e){for(var t in e)this.startTopic(e[t])},startTopic:function(e){if(!(e in this.topics)){if("_"===e.charAt(0)||e.indexOf("-")>=0)throw"Illegal topic name: starts with '_' or contains '-'";this.topics[e]=new this.Topic(e)}},register:function(e,t,a){a||this.validate(t);var r="function"==typeof e[t+"Handler"];if("_"!==t){var i=this.topics[t].receivers;if(r&&i.handler.push(e),1===e.nodeType&&e.hasAttribute("data-depend-"+t)){var n=e.getAttribute("data-depend-"+t).split(",");for(var s in n){var o=n[s];"children"===o||"class"===o?i[n[s]].push(e):(o in i.attr||(i.attr[o]=[]),i.attr[o].push(e))}}}else r&&this.reportTopic.receivers.push(e)},registerDomReceivers:function(e){this.validate(e);for(var t=getByClass("receiver-"+e),a=0;a<t.length;a++)this.register(t[a],e,!0)},unregister:function(e,t){this.validate(t);var a=[],r=this.topics[t].receivers;if(t+"Handler"in e)a.push(r.handler);else{var i=e.getAttribute("data-depend-"+t).split(",");for(var n in i)a.push(r[i[n]]||r.attr[i[n]]||[])}for(var s in a)a[s].splice(a[s].indexOf(e),1)},push:function(e,t){this.validate(e);var a,r=this.topics[e],i=++r.upId,n=String(t);a=r.receivers.handler.length;for(var s=0;s<a&&i===r.upId;s++)r.receivers.handler[s][e+"Handler"](n);for(var o in r.receivers.attr){a=r.receivers.attr[o].length;for(s=0;s<a&&i===r.upId;s++)this.updateByAttr(r.receivers.attr[o][s],o,r,n)}a=r.receivers.class.length;for(s=0;s<a&&i===r.upId;s++)this.updateByClass(r.receivers.class[s],r,n);a=r.receivers.children.length;for(s=0;s<a&&i===r.upId;s++)this.updateByChildren(r.receivers.children[s],r,n);this.reportTopic.queue.push(new this.Record(r,n,i)),this.processReportQueue()},processReportQueue:function(){var e=Updater.reportTopic;if(!e.isBusy&&0!==e.queue.length){e.isBusy=!0;var t=e.queue.shift();for(var a in e.receivers)e.receivers[a]._Handler(t);e.isBusy=!1,e.queue.length>0&&setTimeout(Updater.processReportQueue,0)}},updateByAttr:function(e,t,a,r){var i="data-"+t+"-"+a.name+"-"+r,n=e.hasAttribute(i)?e.getAttribute(i):"";e.setAttribute(t,n)},updateByClass:function(e,t,a){for(var r=e.attributes,i=[],n=0;n<r.length;n++)if(r[n].name.startsWith("data-class-"+t.name+"-")){var s=r[n].value;r[n].name.endsWith("-"+a)?(e.classList.add(s),i.push(s)):i.indexOf(s)<0&&e.classList.remove(r[n].value)}},updateByChildren:function(e,t,a){for(var r=e.children,i=[],n=0;n<r.length;n++)r[n].hasAttribute("data-"+t.name)&&(r[n].getAttribute("data-"+t.name).split(",").indexOf(a)>=0?i.push(r[n]):(r[n].style.display="none",r[n].classList.remove("active")));for(var s in i)i[s].classList.add("active"),i[s].style.removeProperty("display")},validate:function(e){if(!(e in this.topics)&&e!==this.reportTopic.name)throw"Unstarted topic: "+e}};function newElement(e,t,a,r){var i=document.createElement(e);if(Array.isArray(t))for(var n in t)i.classList.add(t[n]);if(Array.isArray(a))for(var s in a){var o=a[s];i.setAttribute(o[0],o[1])}else if("object"==typeof a)for(var p in a)i.setAttribute(p,a[p]);if(Array.isArray(r))for(var n in r)i.appendChild(r[n]);return i}function newText(e){return document.createTextNode(e)}function removeNode(e){e.parentNode.removeChild(e);var t=e.classList;if(t)for(var a=t.length-1;a>=0;a--){var r=t[a].split("-",2);"receiver"===r[0]&&Updater.unregister(e,r[1])}}function getById(e){return document.getElementById(e)}function getByClass(e){return document.getElementsByClassName(e)}function getOneOf(e){return getByClass(e)[0]}function getByPoint(e){return document.elementFromPoint(e.clientX,e.clientY)}function findActiveChild(e){for(var t=e.children,a=0;a<t.length;a++)if(t[a].classList.contains("active"))return t[a];return null}function setProperties(e,t){for(var a in t)e[a]=t[a]}var App={overrides:{before:{},after:{}}};App.Storage={blackList:["_","view","command","fit"],cache:{},passesTopic:function(e){return this.blackList.indexOf(e)<0},get:function(e){return e in this.cache?this.cache[e]:localStorage.getItem(e)},set:function(e,t){this.cache[e]!==t&&localStorage.setItem(e,t),e.startsWith("_")||(this.cache[e]=t)},clear:function(e){localStorage.removeItem(e),delete this.cache[e]},_Handler:function(e){e.upId===e.topic.upId&&this.passesTopic(e.topic.name)&&this.set(e.topic.name,e.value)}},App.Dev={name:App.Storage.get("device")||Env.device,get std(){return"std"===this.name},get touch(){return!this.std},deviceHandler:function(e){var t=App.Storage,a="_prev_dev_text";if(e===this.name){var r=t.get(a);r&&(App.Writer.textArea.value=r,t.clear(a))}else t.set("device",e),t.set(a,App.Writer.textArea.value),location.reload()}},App.Dev.std&&(App.Literator={alphMaps:[],layoutMaps:[],keyHeadSets:[],alphId:-1,layoutId:-1,alphMap:{},layoutMap:{},keyHeadSet:{},tryTrans:function(e){return this.alphMap[e in this.layoutMap?this.layoutMap[e]:e]||""},alphabetHandler:function(e){this.alphId=e,this.alphMap=this.alphMaps[e],this.setKeyHeadSet()},layoutHandler:function(e){this.layoutId=e,this.layoutMap=this.layoutMaps[e],this.setKeyHeadSet()},setKeyHeadSet:function(){this.keyHeadSet=this.keyHeadSets[this.alphId][this.layoutId]}}),App.Dev.touch&&(App.Literator={allChars:{" ":!0,"\n":!0}}),App.Dev.std&&(App.Writer={textArea:null,buffChar:"",xText:"",init:function(){this.textArea=getById("output-std")},catchKeyDown:function(e){var t=App.Writer,a=e.key;if(!e.ctrlKey&&!e.metaKey&&1===a.length&&" "!==a){var r=!0;if(t.buffChar){var i=t.popBuffChar();t.tryAdd(i+a)?r=!1:t.tryAdd(i)}r&&(App.Literator.keyHeadSet[a]?t.buffChar=a:t.tryAdd(a)),e.preventDefault(),e.stopPropagation()}" "!==e.key&&"Enter"!==e.key||(t.tryAdd(t.popBuffChar()),e.stopPropagation()),t.writeResult()},catchKeyUp:function(e){var t=App.Writer;t.buffChar===e.key&&(t.tryAdd(t.popBuffChar()),t.writeResult())},popBuffChar:function(){var e=this.buffChar;return this.buffChar="",e},tryAdd:function(e){var t=App.Literator.tryTrans(e);return this.xText+=t,t},writeResult:function(){var e=this.xText;e&&(this.write(e),this.xText="",setTimeout(App.DomSignaler.signalByXString,0,e))},write:function(e){this.textArea.setRangeText(e,this.textArea.selectionStart,this.textArea.selectionEnd,"end")}}),App.Dev.touch&&(App.Writer={textArea:{div:null,head:newElement("span",["caret"],null,[newText("")]),tail:newElement("span",null,null,[newText("")]),sStart:0,sEnd:0,get value(){return this.div.innerText},set value(e){this.set(this.tail,""),this.set(this.head,""),this.updateSelection(0),this.insert(e)},insert:function(e){var t=this.sStart,a=this.sEnd;if(t===a)this.add(this.head,e);else{App.Selection.clear();var r=this.value;this.set(this.tail,r.substr(a)),this.set(this.head,r.substr(0,t)+e)}this.updateSelection(t+e.length),this.updateCaret()},add:function(e,t){this.set(e,e.innerText+t)},set:function(e,t){removeNode(e.firstChild),e.appendChild(newText(t))},focus:function(){this.div.focus()},select:function(){App.Selection.make(this.div),this.updateSelection(0,this.value.length),this.updateCaret()},updateSelection:function(e,t){this.sStart=e,this.sEnd=t||e},updateCaret:function(){this.sStart===this.sEnd?this.head.classList.add("caret"):this.head.classList.remove("caret")},catchSelection:function(){if(App.Selection.lock)return!1;var e=App.Writer.textArea,t=App.Selection.get(),a=e.head.innerText,r=a.length;if(t.isCollapsed){var i=e.tail.innerText,n=t.anchorOffset;e.isHead(t.anchorNode)?(e.set(e.head,a.substr(0,n)),e.set(e.tail,a.substr(n)+i),e.updateSelection(n)):(e.set(e.tail,i.substr(n)),e.add(e.head,i.substr(0,n)),e.updateSelection(r+n))}else{var s=t.anchorOffset+(e.isHead(t.anchorNode)?0:r),o=t.focusOffset+(e.isHead(t.focusNode)?0:r);e.updateSelection(Math.min(s,o),Math.max(s,o))}e.updateCaret()},isHead:function(e){return e&&(e===this.head||e.parentNode===this.head)}},init:function(){var e=getById("output-touch"),t=this.textArea;e.appendChild(t.head),e.appendChild(t.tail),t.div=e},write:function(e){switch(e){case"@n":e="\n";break;case"@b":var t=this.textArea,a=t.sStart;if(a===t.sEnd&&a>0){for(var r=t.value,i=1,n=1;n<=4&&a-n>=0;n++)if(r.substring(a-n,a)in App.Literator.allChars){i=n;break}t.sStart-=i}e=""}this.textArea.insert(e)}}),App.Writer.clickWrite=function(e){this.textArea.focus(),this.write(e),setTimeout(App.DomSignaler.signalByXString,0,e)},App.Commands={shiftXChars:function(e){var t=findActiveChild(App.DomMarks.xCharsSelectLi);if(t)for(var a=t.firstElementChild;a=a.nextElementSibling;)for(var r=a.children,i=0;i<r.length;i++)if(r[i].classList.contains("active")){var n=i+parseInt(e);n>=0&&n<r.length&&Updater.push(r[i].getAttribute("data-topic"),n);break}},cycleCaptions:function(e){var t=findActiveChild(App.DomMarks.captionsCycleLi.firstElementChild),a=e<0?t.previousElementSibling||t.parentNode.lastElementChild:t.nextElementSibling||t.parentNode.firstElementChild;Updater.push("captions",a.getAttribute("data-captions"))},changeFontSize:function(e){var t=App.OutFontResizer;e?t.tryChange(+e):t.set(t.styleDefault)},saveText:function(){App.Storage.set("_text",App.Writer.textArea.value),Updater.push("loadable_text",+(App.Writer.textArea.value.length>0)),App.DomSignaler.signalButton(App.DomMarks.saveTextButton)},pasteText:function(){var e=App.Storage.get("_text");e&&(App.Writer.write(e),App.Writer.textArea.focus())},selectAll:function(){App.Writer.textArea.focus(),App.Writer.textArea.select()},eraseSelection:function(){App.Writer.write(""),App.Writer.textArea.focus()},commandHandler:function(e){var t=e.split(":"),a=t[0];"function"==typeof this[a]?this[a](t[1]):console.warn("@command",e,"?")}},App.Dev.std&&(App.Commands.catchKeyDown=function(e){!1!==App.Commands.runMatch(e)&&(e.stopPropagation(),e.preventDefault())},App.Commands.runMatch=function(e){var t=this;switch(e.key){case"Help":return App.SelectsController.clear(),Updater.push("view","info"),!0;case"Escape":return App.SelectsController.clear(),Updater.push("view","workspace"),!0;case"ArrowLeft":return e.ctrlKey&&t.shiftXChars(-1);case"ArrowRight":return e.ctrlKey&&t.shiftXChars(1);case"PageUp":return"workspace"===App.ViewController.current&&t.cycleCaptions(-1);case"PageDown":return"workspace"===App.ViewController.current&&t.cycleCaptions(1);case"s":return e.ctrlKey&&t.saveText();case"-":case"_":return e.ctrlKey&&e.shiftKey&&t.changeFontSize(-1);case"+":case"=":return e.ctrlKey&&e.shiftKey&&t.changeFontSize(1);case"0":case")":return e.ctrlKey&&e.shiftKey&&t.changeFontSize(0)}return!1}),App.DomMarks={kBoards:[],get activeKBoard(){return this.kBoards[App.Storage.get("alphabet")]},get textArea(){return App.Writer.textArea.div||App.Writer.textArea},workspace:null,kBoardSpace:null,editorSpace:null,xCharsSelectLi:null,captionsCycleLi:null,saveTextButton:null,goTopButton:null,init:function(){setProperties(this,{workspace:getById("workspace"),kBoardSpace:getById("kboard-space"),editorSpace:getById("editor-space"),xCharsSelectLi:getById("selector-xchars"),captionsCycleLi:getById("cycle-captions"),saveTextButton:getById("save-text-button"),goTopButton:getById("go-top")})}},App.DomSignaler={init:function(){this.signalByXString=function(e){for(var t=App.DomMarks.activeKBoard.backMap,a="",r=null,i=e.length-1;i>=0;i--)(r=t[a=e.charAt(i)+a])&&(App.DomSignaler.signalButton(r,20*i),a="")}},signalByXString:function(){},signalButton:function(e,t){var a=t||0;setTimeout((function(){e.classList.add("signal")}),a),setTimeout((function(){e.classList.remove("signal")}),250+a)}},App.ViewController={scrollChecking:!1,current:null,get requestedView(){return this.isInfoSectionHash(window.location.hash)?"info":"workspace"},viewHandler:function(e){this.current=e,this.clearScrollCheck();var t=window.location.hash;switch(e){case"info":this.isInfoSectionHash(t)||(window.location.hash="info"),this.scrollChecking=setInterval(this.scrollHandler,250);break;case"workspace":t.length>0&&(window.location.hash=""),App.DomMarks.goTopButton.classList.remove("active")}},isInfoSectionHash:function(e,t){return"#info"===e||"i"===e.charAt(1)&&(t||getById(e.substr(1)))},scrollHandler:function(){var e=App.DomMarks.goTopButton.classList;document.scrollingElement.scrollTop>window.innerHeight?e.add("active"):e.remove("active")},clearScrollCheck:function(){!1!==this.scrollChecking&&(clearInterval(this.scrollChecking),this.scrollChecking=!1)}},App.Fitter={setting:null,lock:!1,repeat:!1,compact:!1,compactRet:!1,allFitClasses:["fit-w","fit-h","fit-max","compact"],fitClass:null,boxMaxSize:0,boxMinSize:0,fit:function(){var e=App.Fitter;if(!e.lock||e.compactRet){e.lock=!0,document.body.style.height=window.innerHeight+"px";var t,a,r,i,n=App.DomMarks.kBoardSpace,s=Math.abs(window.innerWidth-n.offsetWidth)<100;n.classList.add("resizing"),e.compactRet||"compact"===e.setting?(e.compact=!0,e.compactRet=!1,t=e.fitCompact,a=App.DomMarks.activeKBoard,r=s,i="compact"):(e.compact=!1,s?(t=e.fitStdNarrowScr,a=getOneOf("tall"),i="fit-w"):(t=e.fitStdWideScr,a=getOneOf("wide"),i="fit-h"),r=a.firstElementChild.firstElementChild.firstElementChild),e.preset(a,i),setTimeout(t,0,e,n,a,r)}else e.repeat=!0},fitCompact:function(e,t,a,r){for(var i=getComputedStyle(a),n=parseInt(i.getPropertyValue("padding-top"))+parseInt(i.getPropertyValue("padding-bottom")),s=a.children,o=0;o<s.length;o++)for(var p=s[o].children,l=0;l<p.length;l++)n+=p[l].offsetHeight;var c=t.offsetHeight-n;if(r){var h=App.DomMarks.editorSpace;h.style.height=h.offsetHeight+c+"px"}else a.style.top=c/2+"px";e.release(t,a)},fitStdNarrowScr:function(e,t,a,r){a.offsetHeight>=t.offsetHeight&&(t.classList.remove("fit-w"),t.classList.add("fit-h")),setTimeout(e.finalizeStd,0,e,t,a,r)},fitStdWideScr:function(e,t,a,r){for(var i=r.offsetHeight,n=!0,s=a.children,o=0;n&&o<s.length;o++)for(var p=s[o].children,l=0;n&&l<p.length;l++){var c=p[l];(c.offsetHeight>=2*i||c.offsetWidth>=t.offsetWidth)&&(t.classList.remove("fit-h"),t.classList.add("fit-w"),n=!1)}setTimeout(e.finalizeStd,0,e,t,a,r)},finalizeStd:function(e,t,a,r){var i=r.offsetWidth;if("auto"===e.setting&&i<e.boxMinSize)return e.compactRet=!0,void e.fit();i>=e.boxMaxSize&&(t.classList.remove("fit-w","fit-h"),t.classList.add("fit-max")),e.release(t,a)},release:function(e,t){var a=App.DomMarks.activeKBoard;t!==a&&(t.style.display="none",a.style.removeProperty("display")),this.lock=!1,this.repeat?(this.repeat=!1,this.fit()):(e.classList.remove("resizing"),Updater.push("fit",this.fitClass))},preset:function(e,t){this.fitClass=t;var a=App.DomMarks;a.editorSpace.style.removeProperty("height");var r=a.kBoardSpace.classList,i=this.allFitClasses;for(var n in i)i[n]!==t&&r.remove(i[n]);r.add(t);var s=a.kBoards;for(var n in s)s[n]!==e&&(s[n].style.display="none"),s[n].style.removeProperty("top");e.style.removeProperty("display")},viewHandler:function(e){"workspace"===e&&this.fit()},alphabetHandler:function(){this.alphabetHandler=function(){this.compact&&setTimeout(this.fit,0)}},kbmodeHandler:function(e){this.setting=e,this.kbmodeHandler=function(e){this.setting=e,this.fit()}},init:function(){var e=newElement("div",["extremes-probe","tmp"]);document.body.appendChild(e);var t=getComputedStyle(e);this.boxMaxSize=parseInt(t.getPropertyValue("max-width")),this.boxMinSize=parseInt(t.getPropertyValue("min-width"))}},App.Messages={topics:{touch:{show:!1,p:null,get on(){return App.Dev.touch}},compact:{show:!1,p:null,on:!1,rec:{start:function(e){Updater.register(e,"fit")},stop:function(e){Updater.unregister(e,"fit")}},fitHandler:function(e){this.on="compact"===e,App.Messages.update(this),App.Messages.superUpdate()}}},container:null,n:2,showN:0,supShow:!1,init:function(){this.container=getById("messages");var e=[],t=[];for(var a in this.topics){var r=this.topics[a];r.p=getById("msg-"+a),App.Storage.get("_msg_"+a)?e.push(a):(r.rec&&r.rec.start(r),this.update(r),t.push(r))}for(var i in e)this.remove(e[i]);if(t.length>0){var n=function(e){for(var t=e.target;!t.id;)t=t.parentNode;App.Messages.dismiss(t.id.split("-")[1])};for(var s in t)t[s].p.addEventListener("click",n)}this.superUpdate()},superUpdate:function(){var e=this.container;this.n<=0?(setTimeout(removeNode,250,e),delete App.Messages):this.showN>0&&!this.supShow?(e.classList.remove("hidden"),this.supShow=!0):this.showN<=0&&this.supShow&&(setTimeout((function(e){e.classList.add("hidden")}),250,e),this.supShow=!1)},update:function(e){var t=e.p.classList;e.on?(t.remove("hidden"),e.show||(this.showN++,e.show=!0)):(t.add("hidden"),e.show&&(this.showN--,e.show=!1))},dismiss:function(e){var t=this.topics[e];t.rec&&t.rec.stop(t),App.Storage.set("_msg_"+e,1),this.remove(e),this.superUpdate()},remove:function(e){var t=this.topics[e];t.show&&this.showN--,this.n--,t.p.classList.add("fading"),setTimeout(removeNode,250,t.p),delete this.topics[e]}},App.OutFontResizer={styleDefault:0,current:0,max:0,min:0,step:0,lineRatio:0,tryChange:function(e){var t=this.current+e*this.step;this.validate(t)&&this.set(t)},validate:function(e){return e>=this.min&&e<=this.max},set:function(e){var t=App.DomMarks.textArea;t.style.fontSize=e+"px",t.style.lineHeight=this.lineRatio*e+"px",this.current=e,App.Storage.set("_fontsize",e)},init:function(){var e=App.DomMarks.textArea,t=getComputedStyle(e),a=parseInt(t.getPropertyValue("font-size"));setProperties(this,{styleDefault:a,min:parseInt(e.getAttribute("data-min-font-size")),max:parseInt(e.getAttribute("data-max-font-size")),step:parseInt(e.getAttribute("data-step-font-size")),lineRatio:parseFloat(t.getPropertyValue("line-height"))/a});var r=parseInt(App.Storage.get("_fontsize"));this.set(this.validate(r)?r:a)}},App.SelectsController={active:{top:null,sub:null},subActivation:!1,handle:function(e){e.classList.contains("sub-select")?this.handleSub(e):this.handleTop(e)},handleTop:function(e){this.clearSub(),this.subActivation=!1,e===this.active.top?this.clearTop():this.setActive(e,"top")},handleSub:function(e){if(e===this.active.sub)return this.clearSub(),void(this.subActivation&&this.clearTop());this.active.top||(this.setActive(this.findContainingSelect(e.parentNode,!1),"top"),this.subActivation=!0),this.setActive(e,"sub")},setActive:function(e,t){var a=!0;this.active[t]&&(this.deactivate(this.active[t],!1),this.active[t].classList.add("lock"),a=!1),this.activate(e,a),this.active[t]=e},clear:function(){this.clearSub(),this.clearTop(),this.subActivation=!1},clearTop:function(){this.active.top&&(this.deactivate(this.active.top,!0),this.active.top=null,this.subActivation=!1)},clearSub:function(){this.active.sub&&(this.deactivate(this.active.sub,!0),this.active.sub=null)},activate:function(e,t){t&&this.setSiblingsLock(e,"add"),e.classList.remove("lock"),e.classList.add("active")},deactivate:function(e,t){t&&this.setSiblingsLock(e,"remove"),e.classList.remove("active")},setSiblingsLock:function(e,t){for(var a=e;(a=a.nextElementSibling||a.parentNode.firstElementChild)!==e;)a.classList.contains("select")&&a.classList[t]("lock")},findContainingSelect:function(e,t){for(var a=0,r=e,i=null;a<5&&!i&&r&&r.classList;a++,r=r.parentNode)if(r.classList.contains("select")&&!r.classList.contains("disabled"))i=r;else if(t&&r.hasAttribute("data-topic"))break;return i}},App.ClickEvents={start:"",end:"",single:"",move:"",init:function(){var e={start:["touchstart","mousedown"],end:["touchend","mouseup"],single:["touch","tap","click","touchend","mouseup"],move:["touchmove","mousemove"]};for(var t in e)for(var a in e[t])if("on"+e[t][a]in document.body){this[t]=e[t][a];break}}},App.ClickRepeater={target:null,repeating:!1,tryId:-1,init:function(){App.ClickEvents.move.startsWith("touch")&&(this.isOut=this.isOutTouch),delete this.isOutTouch},catchStart:function(e){var t=App.ClickRepeater;t.clear();var a=e.target;(a.hasAttribute("data-xchar")||a.classList.contains("repeatable"))&&(t.onMove("add"),t.target=a,setTimeout(t.tryStart,275,++t.tryId))},catchMove:function(e){var t=App.ClickRepeater;t.target&&t.isOut(e)&&t.clear()},tryStart:function(e){var t=App.ClickRepeater;e===t.tryId&&t.target&&!t.repeating&&(t.repeating=setInterval(t.repeat,125))},repeat:function(){var e=App.ClickRepeater;e.target?e.target[App.ClickEvents.single]():e.repeating&&(clearInterval(e.repeating),e.repeating=!1)},clear:function(){var e=App.ClickRepeater;e.target&&(e.onMove("remove"),e.target=null)},onMove:function(e){App.DomMarks.workspace[e+"EventListener"](App.ClickEvents.move,App.ClickRepeater.catchMove)},isOut:function(e){return getByPoint(e)!==this.target},isOutTouch:function(e){var t=e.targetTouches;return 1!==t.length||getByPoint(t[0])!==this.target}},App.Dev.touch&&(App.Selection={root:document.getSelection?document:window,eName:"selectionchange",eElement:null,lock:!1,init:function(){"on"+this.eName in this.root?this.eElement=this.root:(this.eName=App.ClickEvents.end,this.eElement=App.DomMarks.textArea)},get:function(){return this.root.getSelection()},clear:function(e){return(e||this.get()).removeAllRanges()},make:function(e){this.lock=!0;var t=e||App.DomMarks.textArea,a=this.get(),r=document.createRange();r.selectNodeContents(t),this.clear(a),a.addRange(r),setTimeout((function(){App.Selection.lock=!1}),0)}}),App.Constructor={AlphMap:function(e){for(var t in e.entities){var a=e.entities[t];for(var r in a.keys)this[a.keys[r]]=a.chars[0]}},alphabetsData:[],alphId:-1,layoutsData:[],layId:-1,run:function(){App.MenuBuilder.alphSelectLi=getById("selector-alphabet"),App.Dev.std?(App.MenuBuilder.layoutSelectLi=getById("selector-layout"),this.buildLayouts(),this.buildAlphabets(),this.buildKeyHeadSets()):(App.KBoardBuilder.controlsProtos=getById("touch-controls").children,this.buildAlphabets())},buildAlphabets:function(){for(var e;e=this.alphabetsData.shift();)this.buildAlphabet(e);var t=App.KBoardBuilder.wideKBoards;for(var a in t)t[a].classList.add("wide");var r=App.KBoardBuilder.tallKBoards;for(var a in r)r[a].classList.add("tall")},buildAlphabet:function(e){var t,a=++this.alphId,r=null;App.Dev.std?(r=new this.AlphMap(e),App.Literator.alphMaps.push(r),t=function(e){for(var t in this.keys)this.map[this.keys[t]]=this.chars[e];App.DomSignaler.signalByXString(this.chars[e])}):t=function(e){App.DomSignaler.signalByXString(this.chars[e])};var i=[];for(var n in e.entities){var s=e.entities[n];if(App.Dev.touch)for(var o in s.chars)App.Literator.allChars[s.chars[o]]=!0;if(s.chars.length>1){var p="xchar"+a+"_"+n;s.topicName=p,s.map=r,s[p+"Handler"]=t,Updater.startTopic(p),Updater.register(s,p),i.push(s)}}App.MenuBuilder.addAlphabetEntry(e.meta,a),App.MenuBuilder.addXCharsEntry(i,a),App.KBoardBuilder.buildAndAddKboard(e,a)},buildLayouts:function(){for(var e;e=this.layoutsData.shift();)this.buildLayout(e)},buildLayout:function(e){var t=++this.layId;App.Literator.layoutMaps.push(e.map),App.MenuBuilder.addLayoutEntry(e.meta,t)},buildKeyHeadSets:function(){for(var e=0;e<App.Literator.alphMaps.length;e++){var t=App.Literator.alphMaps[e];App.Literator.keyHeadSets[e]=[];for(var a=0;a<App.Literator.layoutMaps.length;a++){var r=App.Literator.layoutMaps[a],i={};for(var n in t)n.length>1&&null!==r[n]&&(i[n.charAt(0)]=!0);App.Literator.keyHeadSets[e][a]=i}}},enterAlphabets:function(){for(var e=0;e<arguments.length;e++)this.alphabetsData.push(arguments[e])},enterLayouts:function(){for(var e=0;e<arguments.length;e++)this.layoutsData.push(arguments[e])}},App.MenuBuilder={alphSelectLi:null,layoutSelectLi:null,addAlphabetEntry:function(e,t){var a=this.alphSelectLi.children[0].children[1],r=this.alphSelectLi.children[1],i=e.name[Env.lang];a.appendChild(newElement("span",null,{"data-alphabet":t},[newText(i)])),r.appendChild(newElement("li",null,null,[newElement("button",["receiver-alphabet"],[["data-topic","alphabet"],["data-alphabet",t],["data-depend-alphabet","class"],["data-class-alphabet-"+t,"active"]],[newElement("span",null,null,[newText(i)]),newText(" "),newElement("span",["xtext"],null,[newText(e.sample)])])]))},addXCharsEntry:function(e,t){var a=App.DomMarks.xCharsSelectLi;if(a.children[0].children[1].appendChild(newElement("span",null,{"data-alphabet":t},[newText(e.length)])),0!==e.length){var r=newElement("ul",["selector-xchar"],{"data-alphabet":t}),i=a.children[1].children[0];for(var n in r.appendChild(i.cloneNode(!0)),e){var s=e[n],o=s.topicName,p=newElement("li");for(var l in s.chars)p.appendChild(newElement("button",["xtext","receiver-"+o].concat(0==l?["active"]:[]),[["data-topic",o],["data-"+o,l],["data-depend-"+o,"class"],["data-class-"+o+"-"+l,"active"]],[newText(s.chars[l])]));r.appendChild(p)}a.appendChild(r)}else a.setAttribute("data-class-alphabet-"+t,"disabled")},addLayoutEntry:function(e,t){this.layoutSelectLi.children[1].appendChild(newElement("li",null,null,[newElement("button",["receiver-layout"],[["data-topic","layout"],["data-layout",t],["data-depend-layout","class"],["data-class-layout-"+t,"active"]],[newText(e.name)])]))}},App.KBoardBuilder={xCharToButton:{},keyToEntity:{},wideKBoards:[],maxColsN:0,tallKBoards:[],maxRowsN:0,subMaxSectionsN:0,controlsProtos:null,buildAndAddKboard:function(e,t){this.xCharToButton={},this.keyToEntity={};var a=newElement("div",["kboard"],{"data-alphabet":t});for(var r in e.entities){var i=e.entities[r];for(var n in this.buildXCharButtons(i),i.keys)this.keyToEntity[i.keys[n]]=i}var s=0,o=0;for(var p in e.order){o++;var l=newElement("section"),c=e.order[p];for(var h in c){s++;var d=newElement("section",["row"]),u=c[h],f=u.length;this.checkForWide(a,f);for(n=0;n<f;n++)d.appendChild(this.buildXLetterBox(u[n]));l.appendChild(d)}a.appendChild(l)}App.Dev.touch&&this.addControlButtons(d),this.checkForTall(a,s,o),a.backMap=this.xCharToButton,App.DomMarks.kBoards.push(a),App.DomMarks.kBoardSpace.appendChild(a)},buildXCharButtons:function(e){for(var t=e.chars.length,a=0;a<t;a++){var r=e.chars[a];this.xCharToButton[r]=newElement("button",["xtext"],[["data-xchar",r]].concat(t>1?[["data-"+e.topicName,a]]:[]).concat(a>0?[["style","display: none;"]]:[]),[newText(r)])}},buildXLetterBox:function(e){for(var t=this.keyToEntity[e],a=t.chars.length,r=newElement("div",["xletter-box"].concat(a>1?["receiver-"+t.topicName]:[]),a>1?[["data-depend-"+t.topicName,"children"]]:null),i=0;i<a;i++)r.appendChild(this.xCharToButton[t.chars[i]]);var n=t.roman.split(" ");return r.appendChild(newElement("p",["roman"],null,[newElement("i",null,null,[newElement("span",null,null,[newText(n[0])])].concat(n.length>1?[newText(" "+n.slice(1).join(" "))]:[]))])),App.Dev.std&&r.appendChild(this.buildKeysP(t)),r},checkForWide:function(e,t){t>this.maxColsN?(this.maxColsN=t,this.wideKBoards=[e]):t===this.maxColsN&&this.wideKBoards.indexOf(e)<0&&this.wideKBoards.push(e)},checkForTall:function(e,t,a){t>this.maxRowsN||t===this.maxRowsN&&a>this.subMaxSectionsN?(this.maxRowsN=t,this.subMaxSectionsN=a,this.tallKBoards=[e]):t===this.maxRowsN&&a===this.subMaxSectionsN&&this.tallKBoards.indexOf(e)<0&&this.tallKBoards.push(e)},buildKeysP:function(e){var t={},a=0;for(var r in App.Literator.layoutMaps){t[s=this.resolveKeys(App.Literator.layoutMaps[r],e.keys)]?t[s]+=","+r:(t[s]=r,a++)}var i=a>1,n=[];for(var s in t){var o=s.split(" ");n.push(newElement("span",null,i?{"data-layout":t[s]}:null,[newElement("span",null,null,[newText(o[0])])].concat(o.length>1?[newText(" "+o.slice(1).join(" "))]:[])))}return newElement("p",["keys","typetext"].concat(i?["receiver-layout"]:[]),[["data-captions","keys"]].concat(i?[["data-depend-layout","children"]]:[]),n)},resolveKeys:function(e,t){var a=[],r=[];for(var i in t){var n=t[i],s=!0;for(var o in e){var p=e[o];null===p&&o===n?s=!1:p===n&&r.push(o)}s&&a.push(n)}return a.concat(r).join(" ")},addControlButtons:function(e){for(var t=0;t<this.controlsProtos.length;t++){var a=this.controlsProtos[t].cloneNode(!0),r=a.firstElementChild;e.appendChild(a),this.xCharToButton[r.getAttribute("data-xchar")]=r}}},App.EventAssigner={run:function(){var e=this.assignments;for(var t in e)e[t]&&e[t]()},assignments:{keyboardWriting:App.Dev.std&&function(){var e=App.Writer.textArea;e.addEventListener("keydown",App.Writer.catchKeyDown),e.addEventListener("keyup",App.Writer.catchKeyUp)},commandKeys:App.Dev.std&&function(){document.addEventListener("keydown",App.Commands.catchKeyDown)},touchSelection:App.Dev.touch&&function(){App.Selection.eElement.addEventListener(App.Selection.eName,App.Writer.textArea.catchSelection)},clickWriting:function(){App.DomMarks.kBoardSpace.addEventListener(App.ClickEvents.single,(function(e){e.target.hasAttribute("data-xchar")&&App.Writer.clickWrite(e.target.getAttribute("data-xchar"))}))},menuClicks:function(){for(var e=function(e){for(var t=null,a=0,r=e.target;a<3&&r&&!t;a++)(t=r.getAttribute("data-topic"))||(r=r.parentNode);t&&Updater.push(t,r.getAttribute("data-"+t))},t=getByClass("menu"),a=t.length-1;a>=0;a--)t[a].addEventListener(App.ClickEvents.single,e);getById("main-menu").addEventListener(App.ClickEvents.single,(function(e){var t=App.SelectsController.findContainingSelect(e.target,!0);t&&(e.stopPropagation(),App.SelectsController.handle(t))}));App.DomMarks.workspace.addEventListener(App.ClickEvents.single,(function(e){App.SelectsController.findContainingSelect(e.target,!1)||App.SelectsController.clear()}))},clickRepeats:function(){for(var e=App.ClickRepeater,t=[App.DomMarks.kBoardSpace,getById("toolbar")],a=t.length-1;a>=0;a--)t[a].addEventListener(App.ClickEvents.start,e.catchStart),t[a].addEventListener(App.ClickEvents.end,e.clear)},resizeHandling:function(){window.addEventListener("resize",App.Fitter.fit)},contextMenuBlocking:App.Dev.touch&&function(){App.DomMarks.workspace.addEventListener("contextmenu",(function(e){for(var t=e.target,a=0;a<2&&t;a++,t=t.parentNode)if(t===App.Writer.textArea.div)return;e.stopPropagation(),e.preventDefault()}))}}},App.buildOutline=function(e){for(var t=function(e,a){if(!(a>0&&"SECTION"===e.tagName&&e.id&&App.ViewController.isInfoSectionHash("#"+e.id,!0)))return null;var r=e.children,i=r[0];if(2!==i.tagName.length||"H"!==i.tagName.charAt(0))return null;for(var n=newElement("li",null,null,[newElement("a",null,{href:"#"+e.id},[newText(i.textContent)])]),s=[],o=1,p=null;o<r.length;o++)(p=t(r[o],a-1))&&s.push(p);return s.length>0&&n.appendChild(newElement("ul",null,null,s)),n},a=getById("outline").children[1],r=getById("info-content").children,i=0,n=null;i<r.length;i++)(n=t(r[i],e))&&a.appendChild(n)},App.removeLoader=function(){setTimeout((function(){getById("loader").classList.add("fading"),setTimeout((function(){removeNode(getById("loader")),document.body.classList.remove("sup-loader")}),500)}),Math.max(0,500-(timestamps.run1-timestamps.head)))},App.overrides.before.NoGoOnCssFlexLack={test:function(){return!("flex-flow"in document.body.style)},run:function(){Env.ok=!1,console.error("Deficient browser (indicated by no flex support).")}},App.overrides.before.JsStringMethodsLack={test:function(){return this.hasSw="".startsWith,this.hasEw="".endsWith,!(this.hasSw&&this.hasEw)},run:function(){this.hasSw||(String.prototype.startsWith=function(e){return this.substr(0,e.length)===e}),this.hasEw||(String.prototype.endsWith=function(e){return this.substr(this.length-e.length)===e})}},App.overrides.after.JsSetRangeTextLack={test:function(){return App.Dev.std&&!App.Writer.textArea.setRangeText},run:function(){App.Writer.textArea.setRangeText=function(e){var t=this.value,a=this.selectionStart;this.value=t.substr(0,a)+e+t.substr(this.selectionEnd),this.selectionStart=this.selectionEnd=a+e.length}}},App.overrides.before.JsScrollingElementLack={test:function(){return!document.scrollingElement},run:function(){document.scrollingElement=document.documentElement}},App.overrides.after.MsKeyboardEvents={test:function(){return App.Dev.std&&"ms"===Env.browser},run:function(){App.MsKAdapter=this.MsKAdapter,App.Writer.textArea.removeEventListener("keydown",App.Writer.catchKeyDown),App.Writer.textArea.addEventListener("keypress",(function(e){App.Writer.catchKeyDown(App.MsKAdapter.normalize(e))})),document.removeEventListener("keydown",App.Commands.catchKeyDown),window.addEventListener("keydown",(function(e){App.Commands.catchKeyDown(App.MsKAdapter.normalize(e))}))},MsKAdapter:{map:{Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",get Unidentified(){switch(event.keyCode){case 187:return"=";case 189:return"-";default:return String.fromCharCode(event.keyCode)}}},normalize:function(e){return{key:this.map[e.key]||e.key,ctrlKey:e.ctrlKey&&!e.altKey,shiftKey:e.shiftKey,preventDefault:this.preventDefault,stopPropagation:this.stopPropagation}},preventDefault:function(){event.preventDefault()},stopPropagation:function(){event.stopPropagation()}}},App.overrides.after.TouchDevCaptions={test:function(){return App.Dev.touch&&"keys"===App.Storage.get("captions")},run:function(){Updater.push("captions","off")}},App.run=function(){for(var e in timestamps.run0=Date.now(),App.overrides.before){(i=App.overrides.before[e]).test()&&(console.log("@"+e),i.run())}for(var t in App.Writer.init(),App.DomMarks.init(),App.ClickEvents.init(),App.ClickRepeater.init(),App.Fitter.init(),App.Dev.touch&&App.Selection.init(),App.Constructor.run(),App.EventAssigner.run(),Updater.startTopics(["device","alphabet","layout","command","view","kbmode","captions","xfont","theme","toolbar","loadable_text","fit"]),Updater.register(App.Storage,"_"),Updater.register(App.Dev,"device"),App.Dev.std&&(Updater.register(App.Literator,"alphabet"),Updater.register(App.Literator,"layout")),Updater.register(App.Commands,"command"),Updater.register(App.ViewController,"view"),Updater.register(App.Fitter,"view"),Updater.register(App.Fitter,"alphabet"),Updater.register(App.Fitter,"kbmode"),Updater.topics)Updater.registerDomReceivers(Updater.topics[t].name);var a={device:App.Dev.name,alphabet:0,layout:0,xfont:"noto",kbmode:"auto",toolbar:App.Dev.std?"on":"off",captions:App.Dev.std?"roman":"off",theme:App.Dev.std?"bright":"dark"};for(var r in a)Updater.push(r,App.Storage.get(r)||a[r]);for(var t in Updater.topics){r=Updater.topics[t].name;App.Storage.passesTopic(r)&&!(r in a)&&Updater.push(r,App.Storage.get(r)||0)}for(var e in Updater.push("view",App.ViewController.requestedView),App.DomSignaler.init(),App.Messages.init(),App.OutFontResizer.init(),App.buildOutline(2),App.overrides.after){var i;(i=App.overrides.after[e]).test()&&(console.log("@"+e),i.run())}timestamps.run1=Date.now(),Env.ok&&App.removeLoader(),App.cleanUp()},App.cleanUp=function(){for(var e in timestamps.clean0=Date.now(),window.removeEventListener("load",App.run),delete App.overrides,delete App.Constructor,delete App.MenuBuilder,delete App.KBoardBuilder,delete App.EventAssigner,delete App.buildOutline,delete App.removeLoader,delete App.run,delete App.cleanUp,App)delete App[e].init;setProperties(Updater.topics.device.receivers,{attr:{},class:[],children:[]});for(var t=getByClass("tmp");t.length>0;)removeNode(t[0]);timestamps.clean1=Date.now(),console.log("@ready",timestamps.clean1-timestamps.head+"ms")},App.Constructor.enterAlphabets({meta:{name:{en:"Elder Futhark",pl:"Futhark starszy"},sample:"ᚠᚢᚦᚨᚱᚲ"},entities:[{chars:["ᚠ"],roman:"f",keys:["f"]},{chars:["ᚢ"],roman:"u",keys:["u"]},{chars:["ᚦ"],roman:"þ",keys:["th"]},{chars:["ᚨ"],roman:"a",keys:["a"]},{chars:["ᚱ"],roman:"r",keys:["r"]},{chars:["ᚲ"],roman:"k",keys:["k"]},{chars:["ᚷ"],roman:"g",keys:["g"]},{chars:["ᚹ"],roman:"w",keys:["w"]},{chars:["ᚺ","ᚻ"],roman:"h",keys:["h"]},{chars:["ᚾ"],roman:"n",keys:["n"]},{chars:["ᛁ"],roman:"i",keys:["i"]},{chars:["ᛃ"],roman:"j",keys:["j"]},{chars:["ᛇ"],roman:"ï æ",keys:["I","E","ae"]},{chars:["ᛈ"],roman:"p",keys:["p"]},{chars:["ᛉ"],roman:"z ʀ",keys:["z","R"]},{chars:["ᛊ","ᛋ"],roman:"s",keys:["s"]},{chars:["ᛏ"],roman:"t",keys:["t"]},{chars:["ᛒ"],roman:"b",keys:["b"]},{chars:["ᛖ"],roman:"e",keys:["e"]},{chars:["ᛗ"],roman:"m",keys:["m"]},{chars:["ᛚ"],roman:"l",keys:["l"]},{chars:["ᛜ"],roman:"ŋ ng",keys:["ng"]},{chars:["ᛟ"],roman:"o",keys:["o"]},{chars:["ᛞ"],roman:"d",keys:["d"]},{chars:["᛫"],roman:"•",keys:[".",","]},{chars:["᛬"],roman:":",keys:[":",";"]}],order:[[["f","u","th","a","r","k","g","w"],["h","n","i","j","I","p","z","s"],["t","b","e","m","l","ng","o","d"]],[[".",":"]]]},{meta:{name:{en:"American Futharch",pl:"American Futharch"},sample:"ᚠᚢᚦᚩᚱᚳ"},entities:[{chars:["ᚠ"],roman:"/f/ f",keys:["f"]},{chars:["ᚢ"],roman:"/u/ u",keys:["u"]},{chars:["ᚦ"],roman:"/θ/ þ",keys:["th"]},{chars:["ᚩ"],roman:"/ɑ/ a",keys:["o"]},{chars:["ᚱ"],roman:"/r/ r",keys:["r"]},{chars:["ᚳ"],roman:"/ʧ/ c",keys:["ch"]},{chars:["ᚷ"],roman:"/g/ g",keys:["g"]},{chars:["ᚹ"],roman:"/w/ w",keys:["w"]},{chars:["ᚻ"],roman:"/h/ h",keys:["h"]},{chars:["ᚾ"],roman:"/n/ n",keys:["n"]},{chars:["ᛁ"],roman:"/ɪ/ i",keys:["i"]},{chars:["ᛄ"],roman:"/j/ y",keys:["y"]},{chars:["ᛇ"],roman:"/i/ e",keys:["I"]},{chars:["ᛈ"],roman:"/p/ p",keys:["p"]},{chars:["ᛉ"],roman:"/z/ z",keys:["z"]},{chars:["ᛋ"],roman:"/s/ s",keys:["s"]},{chars:["ᛏ"],roman:"/t/ t",keys:["t"]},{chars:["ᛒ"],roman:"/b/ b",keys:["b"]},{chars:["ᛖ"],roman:"/ɛ/ ɛ",keys:["e"]},{chars:["ᛗ"],roman:"/m/ m",keys:["m"]},{chars:["ᛚ"],roman:"/l/ l",keys:["l"]},{chars:["ᛝ"],roman:"/ŋ/ ŋ",keys:["ng"]},{chars:["ᛞ"],roman:"/d/ d",keys:["d"]},{chars:["ᛟ"],roman:"/ɔ/ o",keys:["oe"]},{chars:["ᚣ"],roman:"/ʊ/ ø",keys:["U"]},{chars:["ᛡ"],roman:"/v/ v",keys:["v"]},{chars:["ᛊ"],roman:"/ʃ/ ʃ",keys:["sh"]},{chars:["ᛠ"],roman:"/ə/ ə",keys:["ea"]},{chars:["ᛯ"],roman:"/ʒ/ ʒ",keys:["J"]},{chars:["ᛨ"],roman:"/ð/ ð",keys:["dh"]},{chars:["ᚴ"],roman:"/k/ k",keys:["k"]},{chars:["ᛥ"],roman:"/ʤ/ j",keys:["j"]},{chars:["ᚫ"],roman:"/æ/ æ",keys:["ae"]},{chars:[" "],roman:" ",keys:[" "]},{chars:["_"],roman:"_",keys:["_"]},{chars:["ᛖᛁ"],roman:"/eɪ/ ɛi",keys:["ei"]},{chars:["ᛟᛁ"],roman:"/ɔɪ/ oi",keys:["oi"]},{chars:["ᛟᚣ"],roman:"/oʊ/ oø",keys:["ou"]},{chars:["ᚫᛁ"],roman:"/aɪ/ æ",keys:["ai"]},{chars:["ᚫᚣ"],roman:"/aʊ/ æø",keys:["au"]},{chars:["᛫"],roman:"•",keys:[".",","]},{chars:["᛬"],roman:":",keys:[":",";"]},{chars:["⋮"],roman:"q",keys:["q"]},{chars:["᛭"],roman:"+",keys:["+","="]}],order:[[["f","u","th","o","r","ch","g","w"],["h","n","i","y","I","p","z","s"],["t","b","e","m","l","ng","oe","d"],["U","v","sh","ea","J","dh","k","j"],["ae"," ","_","ei","oi","ou","ai","au"]],[[".",":","q","+"]]]}),App.Dev.std&&App.Constructor.enterLayouts({meta:{name:"UNI"},map:{}},{meta:{name:"DA/NO"},map:{"æ":"ae",ae:null,"ø":"oe",oe:null,"å":"A",A:null,O:null,"Æ":"ea"}},{meta:{name:"DE"},map:{"ä":"ae",ae:null,"ö":"oe",oe:null,"Ä":"ea"}},{meta:{name:"FO"},map:{"ð":"dh",dh:null,"æ":"ae",ae:null,"ø":"oe",oe:null,"á":"A","í":"I","ó":"O",O:null,"Æ":"ea"}},{meta:{name:"IS"},map:{"þ":"th",th:null,"ð":"dh",dh:null,"æ":"ae",ae:null,"ö":"oe",oe:null,"á":"A","í":"I","ó":"O",O:null,"Æ":"ea"}},{meta:{name:"SV"},map:{"å":"A",A:null,O:null,"ä":"ae",ae:null,"ö":"oe",oe:null,"Ä":"ea"}}),window.addEventListener("load",App.run);